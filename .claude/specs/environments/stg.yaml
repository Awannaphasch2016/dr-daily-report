# Staging Environment Constraints (AWS)
# Applied to all specifications when targeting stg environment

environment: stg
description: "AWS staging - real APIs, production-like testing"
created: 2026-01-13

# General characteristics
characteristics:
  purpose: "Pre-production validation with real services"
  data_freshness: "24h tolerance"
  performance_sla: "monitored (not enforced)"
  debug_logging: true
  mocks_allowed: false  # Real APIs only

# Deployment triggers
deployment:
  trigger: "push to main branch"
  duration: "~10 minutes"
  approval_required: false

# AWS Resources
resources:
  lambda:
    line_bot: "dr-line-bot-stg"
    telegram_api: "dr-telegram-api-stg"

  aurora:
    cluster: "dr-aurora-stg"
    instance_class: "db.t3.medium"

  s3:
    frontend: "dr-telegram-frontend-stg"
    pdf: "dr-pdf-storage-stg"

# Requirements (stricter than dev)
requirements:
  # Real integrations (same as dev)
  - id: STG-001
    description: "Real LINE API (test channel)"
    rationale: "Validate LINE integration before prod"

  - id: STG-002
    description: "Real Telegram integration"
    rationale: "Validate Telegram Mini App before prod"

  - id: STG-003
    description: "Real Aurora database"
    rationale: "Validate data layer"

  - id: STG-004
    description: "Real Langfuse tracing"
    rationale: "Validate observability"

  # Stricter than dev
  - id: STG-005
    description: "Production-like data volume"
    rationale: "Performance testing"

  - id: STG-006
    description: "All tests must pass"
    rationale: "Gate to production"

  - id: STG-007
    description: "Performance monitored"
    rationale: "Catch regressions before prd"

# Relaxations (vs prd only)
relaxations:
  - id: STG-R001
    description: "Test LINE/Telegram channels (not production)"
    rationale: "Don't impact real users"

  - id: STG-R002
    description: "Debug logging still enabled"
    rationale: "Easier troubleshooting"

  - id: STG-R003
    description: "SLAs monitored but not enforced"
    rationale: "Alert on degradation, don't block"

# Forbidden (same as dev/prd)
forbidden:
  - id: STG-F001
    description: "NO MOCKS"
    severity: "critical"
    rationale: "Mocks only in local environment"

  - id: STG-F002
    description: "No production credentials"
    rationale: "Environment isolation"

# Gate to production
production_gate:
  required_before_prd:
    - "All unit tests pass"
    - "All integration tests pass"
    - "Performance benchmarks acceptable"
    - "Manual smoke test complete"
    - "No critical bugs open"

# Invariant requirements
invariant_requirements:
  linebot:
    level_4:
      - "Real LINE credentials (test channel)"
      - "LANGFUSE_RELEASE set"
    level_3:
      - "Full connectivity verified"
    level_1:
      - "Webhook returns 200 within 20s"
      - "All commands functional"
    level_0:
      - "Full user flow works"

  telegram:
    level_4:
      - "Real API endpoints"
      - "LANGFUSE_RELEASE set"
    level_3:
      - "CloudFront + S3 + Aurora working"
    level_1:
      - "API returns correct responses"
      - "Charts render correctly"
    level_0:
      - "Full user flow works"

# Verification checklist
verification:
  - "Credentials point to stg resources"
  - "NO mock env vars set"
  - "Real APIs configured"
  - "Performance within acceptable range"
  - "All tests passing"
  - "Langfuse traces appearing"

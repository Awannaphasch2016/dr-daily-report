# Validation Report: SQS Workers Generate PDFs

**Claim**: "If we switch to parallel computation (SQS message), PDF generation should just work"

**Type**: `hypothesis` (assumption about system behavior)

**Date**: 2026-01-02

---

## Status: ❌ **FALSE - SQS WORKERS DO NOT GENERATE PDFS**

SQS workers (triggered by Step Functions) do NOT generate PDFs. They call `store_report_from_api()` which **explicitly passes `pdf_s3_key=None`**.

---

## Evidence Summary

### Contradicting Evidence (Workers Don't Generate PDFs): 3 items

1. **Worker Handler Code**
   - **Location**: `src/report_worker_handler.py:221`
   - **Method called**: `PrecomputeService.store_report_from_api()`
   - **Code**:
     ```python
     cache_result = precompute_service.store_report_from_api(
         symbol=ticker,
         report_text=result.get('narrative_report', ''),
         report_json=result,
         chart_base64=final_state.get('chart_base64', ''),
     )
     ```
   - **Analysis**: Worker calls `store_report_from_api()`, NOT `compute_and_store_report()`
   - **Confidence**: High - Direct code evidence

2. **store_report_from_api() Implementation**
   - **Location**: `src/data/aurora/precompute_service.py:1043-1044`
   - **PDF handling**: Explicitly sets PDF fields to None
   - **Code**:
     ```python
     rowcount = self._store_completed_report(
         ticker_id=ticker_id,
         symbol=yahoo_symbol,
         data_date=data_date,
         report_text=report_text,
         report_json=report_json,
         generation_time_ms=generation_time_ms,
         chart_base64=chart_base64,
         pdf_s3_key=None,          # ← EXPLICITLY NO PDF
         pdf_generated_at=None,    # ← EXPLICITLY NO PDF
     )
     ```
   - **Analysis**: Method intentionally skips PDF generation
   - **Purpose**: This method is for API-triggered reports (cache write-through), not scheduled precompute
   - **Confidence**: High - Explicit None assignment

3. **Method Purpose Documentation**
   - **Location**: `src/data/aurora/precompute_service.py:999-1003`
   - **Docstring**:
     ```python
     """Store a report generated by the API worker to Aurora cache.

     This method enables cache write-through from the async report worker,
     allowing subsequent requests for the same ticker to hit the cache
     instead of regenerating the report.
     """
     ```
   - **Analysis**: Method designed for API workers (user requests), not scheduled precompute
   - **Intent**: Cache the LLM-generated report for faster future API responses
   - **NOT intended**: For scheduled PDF generation
   - **Confidence**: High - Docstring confirms intent

### Supporting Evidence: 0 items

**No evidence** that SQS workers generate PDFs.

---

## Analysis

### Overall Assessment

The assumption **"PDF generation should just work with SQS workers"** is **FALSE**.

**Current SQS worker behavior**:
```python
# src/report_worker_handler.py:196-233

1. Receive SQS message (from Step Functions OR API)
2. Parse message (expects job_id + ticker)
3. Run TickerAnalysisAgent (LLM report generation)
4. Transform result to API format
5. Store to DynamoDB jobs table (if job_id exists)
6. Cache to Aurora using store_report_from_api()
   ↓
   pdf_s3_key=None  ← NO PDF GENERATION
   pdf_generated_at=None
```

**Why workers don't generate PDFs**:
- Workers use `store_report_from_api()` for caching
- This method is designed for API requests (write-through cache)
- PDF generation happens in `compute_and_store_report()` (different method)
- Workers NEVER call `compute_and_store_report()`

---

### Key Findings

**Finding 1: Two Separate Code Paths**

| Path | Method | PDF Generation | Use Case |
|------|--------|----------------|----------|
| **API Worker** | `store_report_from_api()` | ❌ NO | User requests via Telegram |
| **Scheduled Precompute** | `compute_and_store_report()` | ✅ YES (if `generate_pdf=True`) | Nightly scheduled reports |

**Problem**: Current SQS workers use the **API path** (no PDFs), not the **scheduled path** (with PDFs)

---

**Finding 2: Workers Expect job_id (API Pattern)**
- **Location**: `src/report_worker_handler.py:132`
- **Code**:
  ```python
  message = json.loads(body)
  job_id = message['job_id']      # ← Required field
  ticker_raw = message['ticker']
  ```
- **Analysis**: Workers expect messages from Telegram API (which creates job_id in DynamoDB)
- **Step Functions messages**: May not include job_id (designed for scheduled workflow)
- **Risk**: Workers may fail if Step Functions doesn't send job_id

---

**Finding 3: Step Functions Workflow Runs Successfully**
- From previous validation: Step Functions executes (46 tickers, 5 min, SUCCEEDED)
- Workers DO process messages and generate LLM reports
- Workers DO cache reports to Aurora
- BUT: Workers use `store_report_from_api()` → NO PDFs

---

**Finding 4: The Fix Required**

To make SQS workers generate PDFs, need to:

**Option A**: Change worker to call `compute_and_store_report()`
```python
# src/report_worker_handler.py:221 (REPLACE)
# OLD: store_report_from_api() - no PDFs
# NEW: compute_and_store_report() - with PDFs

# But this won't work because:
# - Report already generated (agent.graph.invoke() at line 198)
# - compute_and_store_report() generates its OWN report
# - Would run LLM twice (wasteful, expensive)
```

**Option B**: Add PDF generation to worker AFTER LLM report
```python
# src/report_worker_handler.py:215 (ADD AFTER transform_report)

# Generate PDF from existing report
if final_state.get('report'):
    try:
        from src.data.aurora.precompute_service import PrecomputeService
        ps = PrecomputeService()

        pdf_s3_key = ps._generate_and_upload_pdf(
            symbol=ticker,
            data_date=date.today(),
            report_text=final_state['report'],
            chart_base64=final_state.get('chart_base64', '')
        )

        if pdf_s3_key:
            # Update Aurora with PDF key
            ps._update_report_pdf(ticker, date.today(), pdf_s3_key)
            logger.info(f"✅ Generated PDF: {pdf_s3_key}")
    except Exception as e:
        logger.warning(f"⚠️ PDF generation failed: {e}")
        # Continue - report is still valid
```

**Option C**: Create separate worker for scheduled vs API
- `api_worker`: Uses `store_report_from_api()` (no PDFs)
- `scheduled_worker`: Uses `compute_and_store_report()` (with PDFs)
- Step Functions sends to `scheduled_worker` queue
- Telegram API sends to `api_worker` queue

---

### Confidence Level: **High**

**Reasoning**:
- Direct code evidence (`pdf_s3_key=None`)
- Method documentation confirms intent (API cache, not scheduled)
- No code path exists for workers to generate PDFs
- Workers never call `compute_and_store_report()`

---

## Comparison: Expected vs Actual

### Expected (User's Assumption)

```
Step Functions → SQS → Workers → Generate Report + PDF → Aurora
```

**Assumption**: Workers automatically generate PDFs

---

### Actual (Current Implementation)

```
Step Functions → SQS → Workers
  ↓
  Run LLM agent (generate report)
  ↓
  Transform to API format
  ↓
  Store to DynamoDB (if job_id exists)
  ↓
  Cache to Aurora (store_report_from_api)
    ↓
    pdf_s3_key = None  ← NO PDF GENERATION
```

**Reality**: Workers use API code path (no PDFs)

---

## Why This Architecture Exists

**Design intent**:
1. **API workers** (user-triggered):
   - Generate report on-demand (user waits)
   - Cache to Aurora for future hits
   - NO PDFs needed (user gets JSON response)
   - Fast response (no PDF generation delay)

2. **Scheduled precompute** (nightly):
   - Generate report + PDF
   - Store to Aurora for next-day access
   - PDFs available for download
   - Can afford longer execution time

**Problem**: Step Functions workflow uses **API workers** instead of **scheduled workers**

---

## Recommendations

### ❌ **Claim is FALSE**

**DO NOT** assume "switching to SQS will make PDFs work"

**Current SQS workers use API code path** which explicitly skips PDF generation.

---

### Fix Options

**Option A: Add PDF generation to existing workers** (Simplest)
- Modify `report_worker_handler.py` to generate PDF after LLM report
- Call `_generate_and_upload_pdf()` with existing report text
- Update Aurora with pdf_s3_key
- **Effort**: 1-2 hours
- **Risk**: Low (adds optional PDF step)

**Option B: Create dedicated scheduled worker** (Cleanest)
- Create `scheduled_worker_handler.py` separate from `report_worker_handler.py`
- Scheduled worker calls `compute_and_store_report(generate_pdf=True)`
- API worker continues using `store_report_from_api()` (no PDFs)
- Step Functions sends to scheduled worker queue
- **Effort**: 3-4 hours
- **Risk**: Medium (new Lambda, new queue, terraform changes)

**Option C: Add flag to SQS message** (Most Flexible)
- SQS message includes `generate_pdf: true/false` flag
- Worker checks flag and generates PDF if requested
- Step Functions sets `generate_pdf=true`
- API sets `generate_pdf=false`
- **Effort**: 2-3 hours
- **Risk**: Medium (message format changes)

---

### Recommended Approach

**Option A** (add PDF generation to existing workers):

```python
# src/report_worker_handler.py:215 (AFTER transform_report)

# Generate PDF for scheduled workflows (optional for API requests)
# Check if this is a scheduled workflow (no job_id) or API request (has job_id)
if not job_id or message.get('generate_pdf', False):
    try:
        logger.info(f"Generating PDF for {ticker}...")

        from src.data.aurora.precompute_service import PrecomputeService
        ps = PrecomputeService()

        pdf_s3_key = ps._generate_and_upload_pdf(
            symbol=ticker,
            data_date=date.today(),
            report_text=final_state.get('report', ''),
            chart_base64=final_state.get('chart_base64', '')
        )

        if pdf_s3_key:
            # Store to Aurora with PDF
            ps._update_report_pdf(ticker, date.today(), pdf_s3_key, datetime.now())
            logger.info(f"✅ Generated PDF: {pdf_s3_key}")

    except Exception as e:
        logger.warning(f"⚠️ PDF generation failed for {ticker}: {e}")
        # Continue without PDF - report is still valid
```

**Why this works**:
- Uses existing workers (no new infrastructure)
- PDFs generated AFTER LLM report (no duplicate LLM calls)
- Graceful degradation (report succeeds even if PDF fails)
- Optional (only for scheduled workflows or if flag set)

---

## Next Steps

- [ ] Understand why workers use `store_report_from_api()` instead of `compute_and_store_report()`
- [ ] Design: Should scheduled and API workers be separate?
- [ ] Implement: Add PDF generation to workers (Option A)
- [ ] Test: Verify PDFs generated when Step Functions runs
- [ ] Deploy: Update worker Lambda
- [ ] Verify: Check S3 for PDFs after next 5:00 AM run

---

## References

**Code**:
- `src/report_worker_handler.py:221` - Worker calls `store_report_from_api()`
- `src/data/aurora/precompute_service.py:1043` - `pdf_s3_key=None` explicit
- `src/data/aurora/precompute_service.py:804-899` - `compute_and_store_report()` (HAS PDF generation)
- `src/data/aurora/precompute_service.py:991-1057` - `store_report_from_api()` (NO PDF generation)

**Related Validations**:
- `.claude/validations/2026-01-02-step-functions-executes.md` - Step Functions DOES execute
- `.claude/validations/2026-01-02-pdf-requires-llm-report-first.md` - PDF needs LLM report first
- `.claude/bug-hunts/2026-01-02-generate-pdf-true-not-executing.md` - Initial investigation

---

## Conclusion

**Claim: "If we switch to SQS, PDF generation should just work" = FALSE** ❌

**Evidence**:
- ❌ SQS workers call `store_report_from_api()` (no PDFs)
- ❌ Method explicitly sets `pdf_s3_key=None`
- ❌ Method designed for API requests (write-through cache)
- ❌ Workers NEVER call `compute_and_store_report()` (which has PDF generation)

**Reality**:
- ✅ SQS workers DO run (Step Functions confirmed)
- ✅ Workers DO generate LLM reports
- ✅ Workers DO cache reports to Aurora
- ❌ Workers DO NOT generate PDFs

**To fix**: Add PDF generation step to workers (Option A) or create separate scheduled worker (Option B)

---

**Created**: 2026-01-02
**Validation Type**: Hypothesis
**Confidence**: High (direct code evidence)
**Status**: Claim FALSE - requires code changes

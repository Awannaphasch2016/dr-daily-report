name: Fund Data Sync ETL Deployment

# ============================================================================
# Independent ETL Deployment Pipeline
# Separate from main Twinbar deployment - no blocking dependencies
# Triggers on fund_data_sync file changes only
# ============================================================================
on:
  workflow_dispatch:  # Manual trigger for reruns
  push:
    branches:
      - telegram
    paths:
      - 'src/lambda_handlers/fund_data_sync_handler.py'
      - 'src/data/etl/**'
      - 'src/data/aurora/fund_data_repository.py'
      - 'Dockerfile.fund-data-sync'
      - 'requirements-fund-data-sync.txt'
  pull_request:
    branches:
      - telegram
    paths:
      - 'src/lambda_handlers/fund_data_sync_handler.py'
      - 'src/data/etl/**'
      - 'src/data/aurora/fund_data_repository.py'
      - 'Dockerfile.fund-data-sync'
      - 'requirements-fund-data-sync.txt'

env:
  AWS_REGION: ap-southeast-1
  PYTHON_VERSION: '3.11'
  ECR_REGISTRY: 755283537543.dkr.ecr.ap-southeast-1.amazonaws.com

jobs:
  ###############################################################################
  # Stage 0: Quality Gates
  ###############################################################################
  test:
    name: Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pip-audit

      - name: Syntax check
        run: |
          echo "üîç Checking Python syntax..."
          python -m py_compile src/lambda_handlers/fund_data_sync_handler.py src/data/etl/**/*.py src/data/aurora/fund_data_repository.py
          echo "‚úÖ Syntax check passed"

      - name: Unit tests
        run: |
          echo "üß™ Running unit tests..."
          pytest tests/lambda_handlers/test_fund_data_sync_handler.py -v --tb=short \
            -k "not integration and not smoke and not e2e"
          echo "‚úÖ Unit tests passed"

      - name: Security audit
        run: |
          echo "üîí Running security audit..."
          pip-audit --strict --desc || echo "‚ö†Ô∏è Security warnings found (non-blocking)"
        continue-on-error: true

  ###############################################################################
  # Stage 1: Build (immutable artifact - built once, promoted through envs)
  ###############################################################################
  build:
    name: Build Fund Data Sync Image
    needs: [test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      image_uri: ${{ steps.build.outputs.image_uri }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate ECR Repository Exists (Configuration Gate)
        run: |
          ECR_REPOSITORY="dr-daily-report-fund-data-sync"
          
          echo "üîç Validating ECR repository exists: ${ECR_REPOSITORY}"
          
          # Check if repository exists - FAIL if not found (Configuration Validation Pattern)
          if ! aws ecr describe-repositories \
            --repository-names "${ECR_REPOSITORY}" \
            --region "${AWS_REGION}" \
            > /dev/null 2>&1; then
            echo "‚ùå FATAL: ECR repository does not exist: ${ECR_REPOSITORY}"
            echo ""
            echo "   This is CRITICAL infrastructure required for deployment."
            echo "   The repository must be created via Terraform first:"
            echo ""
            echo "   cd terraform"
            echo "   terraform apply  # Creates aws_ecr_repository.fund_data_sync"
            echo ""
            echo "   See: terraform/fund_data_sync.tf"
            echo ""
            echo "   Following CLAUDE.md: Configuration Validation Pattern"
            echo "   - Fail fast when infrastructure is missing"
            echo "   - Never skip critical validation gates"
            exit 1
          fi
          
          echo "‚úÖ ECR repository validated: ${ECR_REPOSITORY}"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Fund Data Sync image to ECR
        id: build
        run: |
          # Generate immutable tag (same pattern as main build)
          SHA_SHORT=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_TAG="sha-${SHA_SHORT}-${TIMESTAMP}"

          # Use fund-data-sync ECR repo (shared across environments, no -dev suffix)
          ECR_REPOSITORY="dr-daily-report-fund-data-sync"
          IMAGE_URI="${{ env.ECR_REGISTRY }}/${ECR_REPOSITORY}:${IMAGE_TAG}"

          echo "üì¶ Building Fund Data Sync Docker image..."
          echo "   Tag: ${IMAGE_TAG}"
          echo "   URI: ${IMAGE_URI}"

          docker build \
            -f Dockerfile.fund-data-sync \
            -t ${IMAGE_URI} \
            .

          echo "üöÄ Pushing to ECR..."
          docker push ${IMAGE_URI}

          echo "‚úÖ Fund Data Sync image pushed: ${IMAGE_URI}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.build.outputs.image_uri }}
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  ###############################################################################
  # Stage 2: Deploy to Dev (Zero-Downtime: Test Before Promote)
  ###############################################################################
  deploy-dev:
    name: Deploy Fund Data Sync (Dev)
    needs: [build]
    if: github.event_name == 'push' && needs.build.result == 'success'
    runs-on: ubuntu-latest
    environment: development

    env:
      FUND_DATA_SYNC_FUNCTION: dr-daily-report-fund-data-sync-dev

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if Fund Data Sync Lambda exists
        id: check-lambda
        run: |
          if aws lambda get-function --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Fund Data Sync Lambda ${{ env.FUND_DATA_SYNC_FUNCTION }} doesn't exist - skipping deployment"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Fund Data Sync to $LATEST
        if: steps.check-lambda.outputs.exists == 'true'
        run: |
          echo "üîÑ Uploading Fund Data Sync code to \$LATEST..."
          aws lambda update-function-code \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --image-uri ${{ needs.build.outputs.image_uri }}
          aws lambda wait function-updated --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }}
          echo "‚úÖ Fund Data Sync code uploaded to \$LATEST"

      - name: Promote Fund Data Sync to live
        if: steps.check-lambda.outputs.exists == 'true'
        run: |
          NEW_VERSION=$(aws lambda publish-version \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --query 'Version' \
            --output text)
          aws lambda update-alias \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --name live \
            --function-version ${NEW_VERSION} 2>/dev/null || \
          aws lambda create-alias \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --name live \
            --function-version ${NEW_VERSION} \
            --description "Production alias for fund data sync - update to rollback"
          echo "‚úÖ Dev Fund Data Sync promoted: version ${NEW_VERSION}"

  ###############################################################################
  # Stage 3: Deploy to Staging
  ###############################################################################
  deploy-staging:
    name: Deploy Fund Data Sync (Staging)
    needs: [build, deploy-dev]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.deploy-dev.result == 'success' || needs.deploy-dev.result == 'skipped')
    runs-on: ubuntu-latest
    environment: staging

    env:
      FUND_DATA_SYNC_FUNCTION: dr-daily-report-fund-data-sync-staging

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if Fund Data Sync Lambda exists
        id: check-lambda
        run: |
          if aws lambda get-function --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Fund Data Sync Lambda ${{ env.FUND_DATA_SYNC_FUNCTION }} doesn't exist - skipping deployment"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Fund Data Sync to $LATEST
        if: steps.check-lambda.outputs.exists == 'true'
        run: |
          echo "üîÑ Uploading Fund Data Sync code to \$LATEST..."
          aws lambda update-function-code \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --image-uri ${{ needs.build.outputs.image_uri }}
          aws lambda wait function-updated --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }}
          echo "‚úÖ Fund Data Sync code uploaded to \$LATEST"

      - name: Promote Fund Data Sync to live
        if: steps.check-lambda.outputs.exists == 'true'
        run: |
          NEW_VERSION=$(aws lambda publish-version \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --query 'Version' \
            --output text)
          aws lambda update-alias \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --name live \
            --function-version ${NEW_VERSION} 2>/dev/null || \
          aws lambda create-alias \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --name live \
            --function-version ${NEW_VERSION} \
            --description "Production alias for fund data sync - update to rollback"
          echo "‚úÖ Staging Fund Data Sync promoted: version ${NEW_VERSION}"

  ###############################################################################
  # Stage 4: Deploy to Prod
  ###############################################################################
  deploy-prod:
    name: Deploy Fund Data Sync (Prod)
    needs: [build, deploy-staging]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.deploy-staging.result == 'success' || needs.deploy-staging.result == 'skipped')
    runs-on: ubuntu-latest
    environment: production

    env:
      FUND_DATA_SYNC_FUNCTION: dr-daily-report-fund-data-sync-prod

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if Fund Data Sync Lambda exists
        id: check-lambda
        run: |
          if aws lambda get-function --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Fund Data Sync Lambda ${{ env.FUND_DATA_SYNC_FUNCTION }} doesn't exist - skipping deployment"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Fund Data Sync to $LATEST
        if: steps.check-lambda.outputs.exists == 'true'
        run: |
          echo "üîÑ Uploading Fund Data Sync code to \$LATEST..."
          aws lambda update-function-code \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --image-uri ${{ needs.build.outputs.image_uri }}
          aws lambda wait function-updated --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }}
          echo "‚úÖ Fund Data Sync code uploaded to \$LATEST"

      - name: Promote Fund Data Sync to live
        if: steps.check-lambda.outputs.exists == 'true'
        run: |
          NEW_VERSION=$(aws lambda publish-version \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --query 'Version' \
            --output text)
          aws lambda update-alias \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --name live \
            --function-version ${NEW_VERSION} 2>/dev/null || \
          aws lambda create-alias \
            --function-name ${{ env.FUND_DATA_SYNC_FUNCTION }} \
            --name live \
            --function-version ${NEW_VERSION} \
            --description "Production alias for fund data sync - update to rollback"
          echo "‚úÖ Prod Fund Data Sync promoted: version ${NEW_VERSION}"

  ###############################################################################
  # Final: Deployment Summary
  ###############################################################################
  notify:
    name: Deployment Complete
    needs: [build, deploy-dev, deploy-staging, deploy-prod]
    runs-on: ubuntu-latest
    if: always() && !cancelled() && !contains(needs.*.result, 'failure')

    steps:
      - name: Deployment Summary
        run: |
          echo "üéâ Fund Data Sync ETL Deployment Complete!"
          echo ""
          echo "üì¶ Image: ${{ needs.build.outputs.image_tag }}"
          echo ""
          echo "üè∑Ô∏è  Deployed to all environments:"
          echo "   ‚úÖ Dev:     ${{ needs.deploy-dev.result }}"
          echo "   ‚úÖ Staging: ${{ needs.deploy-staging.result }}"
          echo "   ‚úÖ Prod:    ${{ needs.deploy-prod.result }}"
          echo ""
          echo "üõ°Ô∏è  Zero-Downtime Pattern: Independent ETL deployment"
          echo "   ‚Ä¢ No dependencies on Twinbar deployment"
          echo "   ‚Ä¢ ETL issues don't block application deployment"

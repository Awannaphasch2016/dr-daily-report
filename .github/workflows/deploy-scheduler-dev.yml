name: Deploy Scheduler - Dev Environment

# ============================================================================
# Scheduler-Specific Deployment: dev branch â†’ dev environment
# Runs when scheduler or data layer code changes
# Does NOT trigger on agent/workflow changes (scheduler only fetches raw data)
# Required: Scheduler uses same Docker image as Telegram/LINE
# ============================================================================
on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - dev
    paths:
      # Scheduler-specific paths
      - 'src/scheduler/**'
      # Data layer (used by scheduler for Aurora storage)
      - 'src/data/**'
      # Infrastructure
      - 'Dockerfile*'
      - 'requirements*.txt'
      - 'terraform/scheduler.tf'
      - '.github/workflows/deploy-scheduler-dev.yml'
      # Explicitly EXCLUDE agent/workflow (scheduler doesn't use these)
      - '!src/agent.py'
      - '!src/workflow/**'
      - '!src/report/**'  # Report generation not used by scheduler

env:
  AWS_REGION: ap-southeast-1
  PYTHON_VERSION: '3.11'
  ECR_REGISTRY: 755283537543.dkr.ecr.ap-southeast-1.amazonaws.com
  FUNCTION_NAME: dr-daily-report-ticker-scheduler-dev

jobs:
  ###############################################################################
  # Stage 0: Detect Changes
  ###############################################################################
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      scheduler: ${{ steps.filter.outputs.scheduler }}
      data: ${{ steps.filter.outputs.data }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            scheduler:
              - 'src/scheduler/**'
            data:
              - 'src/data/**'

      - name: Log detected changes
        run: |
          echo "ðŸ“Š Change Detection Results:"
          echo "   Scheduler code:    ${{ steps.filter.outputs.scheduler }}"
          echo "   Data layer:        ${{ steps.filter.outputs.data }}"

  ###############################################################################
  # Stage 1: Quality Gates
  ###############################################################################
  test:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scheduler == 'true' || needs.detect-changes.outputs.data == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Syntax check
        run: |
          echo "ðŸ” Checking Python syntax..."
          python -m py_compile src/scheduler/**/*.py src/data/**/*.py
          echo "âœ… Syntax check passed"

      - name: Unit tests (scheduler)
        run: |
          echo "ðŸ§ª Running scheduler tests..."
          pytest tests/data tests/shared -m "not integration and not e2e" -v --tb=short -x
          echo "âœ… Scheduler tests passed"

  ###############################################################################
  # Stage 2: Get or Build Docker Image
  ###############################################################################
  get-or-build-image:
    name: Get or Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    outputs:
      image_uri: ${{ steps.determine-image.outputs.image_uri }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if image already exists for this commit
        id: check-existing
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          IMAGE_TAG="sha-${COMMIT_SHA}"

          # Check if Telegram/LINE already built this commit
          if aws ecr describe-images \
            --repository-name dr-daily-report-telegram-api \
            --image-ids imageTag=${IMAGE_TAG} \
            --region ${{ env.AWS_REGION }} > /dev/null 2>&1; then
            echo "âœ… Found existing image: ${IMAGE_TAG}"
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          else
            echo "âŒ No existing image found for commit ${COMMIT_SHA}"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to Amazon ECR
        if: steps.check-existing.outputs.exists == 'false'
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Build and push Docker image
        if: steps.check-existing.outputs.exists == 'false'
        id: build
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          IMAGE_TAG="sha-${COMMIT_SHA}-${TIMESTAMP}"
          IMAGE_URI="${{ env.ECR_REGISTRY }}/dr-daily-report-telegram-api:${IMAGE_TAG}"

          echo "ðŸ³ Building Docker image..."
          docker build -t ${IMAGE_URI} -f Dockerfile .

          echo "ðŸ“¤ Pushing to ECR..."
          docker push ${IMAGE_URI}

          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Determine final image URI
        id: determine-image
        run: |
          if [ "${{ steps.check-existing.outputs.exists }}" == "true" ]; then
            IMAGE_URI="${{ env.ECR_REGISTRY }}/dr-daily-report-telegram-api:${{ steps.check-existing.outputs.image_tag }}"
            echo "Using existing image: ${IMAGE_URI}"
          else
            IMAGE_URI="${{ steps.build.outputs.image_uri }}"
            echo "Using newly built image: ${IMAGE_URI}"
          fi
          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT

  ###############################################################################
  # Stage 3: Deploy Scheduler Lambda
  ###############################################################################
  deploy-scheduler:
    name: Deploy Scheduler to Dev
    runs-on: ubuntu-latest
    needs: get-or-build-image

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Lambda function code ($LATEST)
        run: |
          echo "ðŸš€ Updating Scheduler Lambda..."
          aws lambda update-function-code \
            --function-name ${{ env.FUNCTION_NAME }} \
            --image-uri ${{ needs.get-or-build-image.outputs.image_uri }}

          echo "â³ Waiting for function update to complete..."
          aws lambda wait function-updated \
            --function-name ${{ env.FUNCTION_NAME }}

          echo "âœ… Scheduler Lambda updated to ${{ needs.get-or-build-image.outputs.image_uri }}"

      - name: Smoke test $LATEST (trigger manual fetch)
        run: |
          echo "ðŸ§ª Testing scheduler with manual ticker fetch..."

          # Test with a single ticker
          aws lambda invoke \
            --function-name ${{ env.FUNCTION_NAME }} \
            --payload '{"tickers":["NVDA"]}' \
            /tmp/scheduler-test.json

          # Check response
          cat /tmp/scheduler-test.json

          if grep -q "error\|Error" /tmp/scheduler-test.json; then
            echo "âŒ Scheduler smoke test failed"
            exit 1
          fi

          echo "âœ… Scheduler smoke test passed"

      - name: Publish new version
        id: publish
        run: |
          echo "ðŸ“¦ Publishing immutable version..."
          VERSION=$(aws lambda publish-version \
            --function-name ${{ env.FUNCTION_NAME }} \
            --description "Scheduler dev deployment $(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --query 'Version' \
            --output text)

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Published version: $VERSION"

      - name: Update 'live' alias to new version (ZERO-DOWNTIME PROMOTION)
        run: |
          echo "ðŸ”€ Promoting version ${{ steps.publish.outputs.version }} to live..."

          # Check if alias exists
          if aws lambda get-alias \
            --function-name ${{ env.FUNCTION_NAME }} \
            --name live > /dev/null 2>&1; then

            # Update existing alias
            aws lambda update-alias \
              --function-name ${{ env.FUNCTION_NAME }} \
              --name live \
              --function-version ${{ steps.publish.outputs.version }}
          else
            # Create new alias
            aws lambda create-alias \
              --function-name ${{ env.FUNCTION_NAME }} \
              --name live \
              --function-version ${{ steps.publish.outputs.version }}
          fi

          echo "âœ… Scheduler 'live' alias now points to version ${{ steps.publish.outputs.version }}"
          echo "ðŸŽ‰ EventBridge will use this version for daily runs"

  ###############################################################################
  # Stage 4: Store Artifact Metadata (for staging promotion)
  ###############################################################################
  store-artifact:
    name: Store Artifact Metadata
    runs-on: ubuntu-latest
    needs: [get-or-build-image, deploy-scheduler]

    steps:
      - name: Save artifact metadata
        run: |
          echo "${{ needs.get-or-build-image.outputs.image_uri }}" > scheduler-artifact-uri.txt
          cat scheduler-artifact-uri.txt

      - name: Upload artifact metadata
        uses: actions/upload-artifact@v4
        with:
          name: scheduler-dev-artifact-metadata
          path: scheduler-artifact-uri.txt
          retention-days: 30

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Scheduler Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** dev" >> $GITHUB_STEP_SUMMARY
          echo "**Function:** ${{ env.FUNCTION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ needs.get-or-build-image.outputs.image_uri }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Daily Schedule" >> $GITHUB_STEP_SUMMARY
          echo "- EventBridge triggers daily at 8 AM Bangkok time (01:00 UTC)" >> $GITHUB_STEP_SUMMARY
          echo "- Fetches 46 tickers from Yahoo Finance" >> $GITHUB_STEP_SUMMARY
          echo "- Stores raw data to Aurora ticker_data table" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Scheduler deployed and promoted to live alias" >> $GITHUB_STEP_SUMMARY

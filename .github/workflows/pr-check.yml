name: PR Check

on:
  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: '3.11'

jobs:
  ###############################################################################
  # Quick validation for PRs (no build/deploy)
  ###############################################################################
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Syntax check
        run: |
          echo "üîç Checking Python syntax..."
          python -m py_compile src/**/*.py src/api/*.py dr_cli/**/*.py
          echo "‚úÖ Syntax check passed"

      - name: Type hints check (optional)
        run: |
          echo "üìù Checking type hints..."
          pip install mypy types-requests
          mypy src/api/ --ignore-missing-imports --no-error-summary || echo "‚ö†Ô∏è Type issues found (non-blocking)"
        continue-on-error: true

      - name: Unit tests
        run: |
          echo "üß™ Running unit tests..."
          pytest tests/telegram tests/shared -m "not integration and not e2e" -v --tb=short -x
          echo "‚úÖ Unit tests passed"

      - name: Test coverage
        run: |
          pip install pytest-cov
          pytest tests/telegram tests/shared -m "not integration and not e2e" \
            --cov=src --cov-report=term-missing --cov-fail-under=50 \
            || echo "‚ö†Ô∏è Coverage below 50%"
        continue-on-error: true

  ###############################################################################
  # Aurora Schema Contract Validation (BLOCKING)
  ###############################################################################
  schema-validation:
    name: Validate Aurora Schema Contract
    runs-on: ubuntu-latest
    needs: validate  # Run after basic validation passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio boto3 pymysql

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Run Comprehensive Schema Tests
        id: schema-tests
        env:
          SCHEDULER_LAMBDA_NAME: dr-daily-report-ticker-scheduler-dev
        run: |
          echo "üîç Validating Aurora schema matches code expectations..."
          echo ""
          echo "This test auto-extracts expected columns from INSERT queries"
          echo "and validates Aurora schema has all required columns."
          echo ""

          # Run comprehensive schema validation tests
          pytest tests/infrastructure/test_aurora_schema_comprehensive.py \
            -v --tb=short -m integration \
            2>&1 | tee /tmp/schema-test-output.txt

          # Capture exit code
          TEST_EXIT_CODE=${PIPESTATUS[0]}

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ Schema validation PASSED - Aurora matches code expectations"
          else
            echo ""
            echo "‚ùå Schema validation FAILED - see test output above"
            echo ""
            echo "üîß To fix:"
            echo "  1. Check test output for missing columns"
            echo "  2. Create migration to add missing columns"
            echo "  3. Run: python scripts/migrate_add_columns.py"
            echo "  4. Push migration file to this PR"
            echo ""
            exit 1
          fi

      - name: Comment on PR if schema mismatch
        if: failure() && steps.schema-tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/schema-test-output.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Schema Validation Failed**

            The Aurora database schema does not match code expectations.

            **Test Output:**
            \`\`\`
            ${output.slice(-2000)}
            \`\`\`

            **What to do:**
            1. Check test output above for missing columns and file locations
            2. Create migration to add missing columns to Aurora
            3. Run migration against dev Aurora (via Lambda or script)
            4. Push migration file to this PR
            5. Tests will re-run automatically

            **TDD Principle:**
            Schema changes require migration FIRST, code changes SECOND.

            **Reference:**
            - Test file: \`tests/infrastructure/test_aurora_schema_comprehensive.py\`
            - Migration handler: \`src/migration_handler.py\`
            `
            })

  ###############################################################################
  # Docker Container Import Validation (BLOCKING)
  ###############################################################################
  docker-validation:
    name: Validate Lambda Handlers in Docker
    runs-on: ubuntu-latest
    needs: validate  # Run after basic validation passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run Docker Import Tests
        id: docker-tests
        run: |
          echo "üê≥ Validating Lambda handlers import in Docker container..."
          echo ""
          echo "This test validates handlers work in ACTUAL Lambda runtime environment,"
          echo "not just in local development environment. Catches phase boundary"
          echo "violations (Development ‚Üí Lambda Runtime) BEFORE deployment."
          echo ""
          echo "Background:"
          echo "- Dec 2025: LINE bot 7-day outage (ImportError in production, tests passed locally)"
          echo "- Jan 2026: query_tool_handler import error (deployment blocker)"
          echo ""

          # Run Docker import tests
          pytest tests/infrastructure/test_handler_imports_docker.py \
            -v --tb=short \
            2>&1 | tee /tmp/docker-test-output.txt

          # Capture exit code
          TEST_EXIT_CODE=${PIPESTATUS[0]}

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ Docker validation PASSED - All handlers import successfully in Lambda container"
          else
            echo ""
            echo "‚ùå Docker validation FAILED - Handler import errors detected"
            echo ""
            echo "üîß To fix:"
            echo "  1. Check test output for import errors"
            echo "  2. Verify Dockerfile COPY directives include all handler files"
            echo "  3. Test locally: pytest tests/infrastructure/test_handler_imports_docker.py -v"
            echo "  4. Debug in container: docker run -it --entrypoint bash dr-lambda-test"
            echo ""
            exit 1
          fi

      - name: Comment on PR if Docker validation fails
        if: failure() && steps.docker-tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/docker-test-output.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Docker Container Validation Failed**

            Lambda handlers failed to import in Docker container environment.

            **Why this matters:**
            - Local import tests passed, but Lambda container imports failed
            - This is a **phase boundary violation** (Development ‚Üí Lambda Runtime)
            - Would cause production failures if deployed

            **Test Output:**
            \`\`\`
            ${output.slice(-2000)}
            \`\`\`

            **What to do:**
            1. Check test output above for specific import errors
            2. Verify \`Dockerfile\` COPY directives include all handler files
            3. Test locally: \`pytest tests/infrastructure/test_handler_imports_docker.py -v\`
            4. Debug interactively: \`docker run -it --entrypoint bash dr-lambda-test\`
            5. Inside container, test import: \`python3 -c "import module_name"\`

            **Common causes:**
            - Missing file in Dockerfile COPY directive
            - Import path assumes local structure (not /var/task)
            - Dependency missing from requirements.txt
            - Module __init__.py missing

            **Principle violated:**
            - **#19**: Cross-Boundary Contract Testing (phase boundary not tested)
            - **#10**: Testing Anti-Patterns (deployment artifacts not tested)

            **Historical context:**
            - Dec 2025: LINE bot 7-day outage (same root cause)
            - Jan 2026: query_tool_handler import error (deployment blocker)

            **Reference:**
            - Test file: \`tests/infrastructure/test_handler_imports_docker.py\`
            - Checklist: \`.claude/checklists/lambda-deployment.md\`
            `
            })

  ###############################################################################
  # Terraform validation (if terraform files changed)
  ###############################################################################
  terraform:
    name: Terraform Check
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'terraform/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

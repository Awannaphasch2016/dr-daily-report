name: PR Check

on:
  pull_request:
    branches: [main, telegram]
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: '3.11'

jobs:
  ###############################################################################
  # Quick validation for PRs (no build/deploy)
  ###############################################################################
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Syntax check
        run: |
          echo "üîç Checking Python syntax..."
          python -m py_compile src/**/*.py src/api/*.py dr_cli/**/*.py
          echo "‚úÖ Syntax check passed"

      - name: Type hints check (optional)
        run: |
          echo "üìù Checking type hints..."
          pip install mypy types-requests
          mypy src/api/ --ignore-missing-imports --no-error-summary || echo "‚ö†Ô∏è Type issues found (non-blocking)"
        continue-on-error: true

      - name: Unit tests
        run: |
          echo "üß™ Running unit tests..."
          pytest tests/telegram tests/shared -m "not integration and not e2e" -v --tb=short -x
          echo "‚úÖ Unit tests passed"

      - name: Test coverage
        run: |
          pip install pytest-cov
          pytest tests/telegram tests/shared -m "not integration and not e2e" \
            --cov=src --cov-report=term-missing --cov-fail-under=50 \
            || echo "‚ö†Ô∏è Coverage below 50%"
        continue-on-error: true

  ###############################################################################
  # Terraform validation (if terraform files changed)
  ###############################################################################
  terraform:
    name: Terraform Check
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'terraform/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

from typing import TypedDict, Annotated, Sequence
from langgraph.graph import StateGraph, END
from langchain_openai import ChatOpenAI
from langchain_core.messages import HumanMessage, AIMessage
import operator
from datetime import datetime
from src.data_fetcher import DataFetcher
from src.technical_analysis import TechnicalAnalyzer
from src.database import TickerDatabase

class AgentState(TypedDict):
    messages: Annotated[Sequence[HumanMessage | AIMessage], operator.add]
    ticker: str
    ticker_data: dict
    indicators: dict
    report: str
    error: str

class TickerAnalysisAgent:
    def __init__(self):
        self.llm = ChatOpenAI(model="gpt-4o", temperature=0.8)
        self.data_fetcher = DataFetcher()
        self.technical_analyzer = TechnicalAnalyzer()
        self.db = TickerDatabase()
        self.ticker_map = self.data_fetcher.load_tickers()
        self.graph = self.build_graph()

    def build_graph(self):
        """Build LangGraph workflow"""
        workflow = StateGraph(AgentState)

        # Add nodes
        workflow.add_node("fetch_data", self.fetch_data)
        workflow.add_node("analyze_technical", self.analyze_technical)
        workflow.add_node("generate_report", self.generate_report)

        # Add edges
        workflow.set_entry_point("fetch_data")
        workflow.add_edge("fetch_data", "analyze_technical")
        workflow.add_edge("analyze_technical", "generate_report")
        workflow.add_edge("generate_report", END)

        return workflow.compile()

    def fetch_data(self, state: AgentState) -> AgentState:
        """Fetch ticker data from Yahoo Finance"""
        ticker = state["ticker"]

        # Get Yahoo ticker from symbol
        yahoo_ticker = self.ticker_map.get(ticker.upper())

        if not yahoo_ticker:
            state["error"] = f"‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ticker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {ticker}"
            return state

        # Fetch data
        data = self.data_fetcher.fetch_ticker_data(yahoo_ticker)

        if not data:
            state["error"] = f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {ticker} ({yahoo_ticker}) ‡πÑ‡∏î‡πâ"
            return state

        # Get additional info
        info = self.data_fetcher.get_ticker_info(yahoo_ticker)
        data.update(info)

        # Save to database
        self.db.insert_ticker_data(
            ticker, yahoo_ticker, data['date'],
            {
                'open': data['open'],
                'high': data['high'],
                'low': data['low'],
                'close': data['close'],
                'volume': data['volume'],
                'market_cap': data.get('market_cap'),
                'pe_ratio': data.get('pe_ratio'),
                'eps': data.get('eps'),
                'dividend_yield': data.get('dividend_yield')
            }
        )

        state["ticker_data"] = data
        return state

    def analyze_technical(self, state: AgentState) -> AgentState:
        """Analyze technical indicators"""
        if state.get("error"):
            return state

        ticker_data = state["ticker_data"]
        hist_data = ticker_data.get('history')

        if hist_data is None or hist_data.empty:
            state["error"] = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå"
            return state

        # Calculate indicators
        indicators = self.technical_analyzer.calculate_all_indicators(hist_data)

        if not indicators:
            state["error"] = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì indicators ‡πÑ‡∏î‡πâ"
            return state

        # Save indicators to database
        yahoo_ticker = self.ticker_map.get(state["ticker"].upper())
        self.db.insert_technical_indicators(
            yahoo_ticker, ticker_data['date'], indicators
        )

        state["indicators"] = indicators
        return state

    def generate_report(self, state: AgentState) -> AgentState:
        """Generate Thai language report using LLM"""
        if state.get("error"):
            return state

        ticker = state["ticker"]
        ticker_data = state["ticker_data"]
        indicators = state["indicators"]

        # Prepare context for LLM
        context = self.prepare_context(ticker, ticker_data, indicators)

        # Generate report using LLM
        prompt = f"""You are a world-class financial analyst like Aswath Damodaran. Write in Thai, tell stories with data.

Data:
{context}

Write a narrative-driven report covering TECHNICAL + FUNDAMENTAL + RELATIVE analysis.

Use the Market Condition components (volatility, buy/sell pressure, volume) as NARRATIVE ELEMENTS throughout your analysis.

Structure (in Thai):

üìñ **‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏´‡∏∏‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ**
Start with market condition, then weave in technical trend and fundamental story in 2-3 sentences.

Example:
"Honda ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à - ‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ ATR ‡πÅ‡∏Ñ‡πà 2% ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ä‡πâ‡∏≤ ‡∏ó‡∏∞‡∏•‡∏∏ SMA 200 ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ (1,583 vs 1,341) ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡πÅ‡∏ï‡πà‡∏Å‡∏≥‡πÑ‡∏£‡∏•‡∏î 42% ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á"

üí° **‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ**
Write 3-4 insights combining ALL THREE analysis types:

1. TECHNICAL + MARKET CONDITION:
"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏£‡∏á - ‡∏ó‡∏∞‡∏•‡∏∏ SMA ‡∏ó‡∏±‡πâ‡∏á 3 ‡πÄ‡∏™‡πâ‡∏ô ($461 vs $439 vs $405) ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ATR ‡πÅ‡∏Ñ‡πà 1.2% ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏ï‡πà‡∏≥ ‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏°‡∏î‡∏∏‡∏• ‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏£‡∏µ‡∏ö‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß"

2. FUNDAMENTAL + BUY/SELL PRESSURE:
"‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ß‡∏±‡∏á - P/E 322 ‡πÅ‡∏û‡∏á‡∏°‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á ‡∏£‡∏≤‡∏Ñ‡∏≤ 2.5% ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ VWAP ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏î‡∏µ ‡∏Ñ‡∏ô‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"

3. RELATIVE + VOLUME:
"‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤ $395 ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô $461 ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡πÄ‡∏á‡∏µ‡∏¢‡∏ö 0.7x ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏°‡πà‡∏Å‡∏•‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏£‡∏≠‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô"

4. TECHNICAL + VOLATILITY + FUNDAMENTAL:
"RSI 59 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÇ‡∏ã‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏∏‡πà‡∏á ATR 3.8% ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏±‡∏á‡πÄ‡∏• ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÇ‡∏ï 11% ‡πÅ‡∏ï‡πà‡∏Å‡∏≥‡πÑ‡∏£‡∏•‡∏î 37% ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏∏‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ"

üéØ **‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ?**
Give clear action (BUY MORE / SELL / HOLD) based on ALL analysis + market condition:

"‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ HOLD - ‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ï‡πà P/E ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏µ‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏£‡∏≠‡∏Å‡∏≥‡πÑ‡∏£‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô"

‚ö†Ô∏è **‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏≠‡∏∞‡πÑ‡∏£?**
Warn about risks from volatility + volume + fundamentals:

"‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏û‡∏∏‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (ATR ‡πÄ‡∏Å‡∏¥‡∏ô 4%) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î (>2x) ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏ç‡πà ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏£‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß ‡∏ï‡∏±‡πâ‡∏á stop-loss ‡πÑ‡∏ß‡πâ 5-7%"

Rules:
- ALWAYS use volatility/ATR, buy/sell pressure/VWAP, and volume IN your narratives
- Combine technical + fundamental + relative analysis
- NO raw numbers alone - always explain what they MEAN
- Write flowing Thai, not bullet points
- Keep under 12 lines total

BAD: "ATR = 2.5"
GOOD: "ATR 2.5% ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏Å‡∏ß‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏≠‡∏≤‡∏à‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á 2-3% ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢ ‡∏ï‡∏±‡πâ‡∏á stop-loss ‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á"

BAD: "VWAP = 450, Price = 461"
GOOD: "‡∏£‡∏≤‡∏Ñ‡∏≤ 461 ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ VWAP 450 ‡∏ñ‡∏∂‡∏á 2.4% ‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏î‡∏µ"

BAD: "Volume ratio = 1.8"
GOOD: "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á 1.8x ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞"

Write entirely in Thai, naturally flowing."""

        response = self.llm.invoke([HumanMessage(content=prompt)])
        report = response.content

        # Save report to database
        yahoo_ticker = self.ticker_map.get(ticker.upper())
        self.db.save_report(
            yahoo_ticker,
            ticker_data['date'],
            {
                'report_text': report,
                'technical_summary': self.technical_analyzer.analyze_trend(indicators, indicators.get('current_price')),
                'fundamental_summary': f"P/E: {ticker_data.get('pe_ratio', 'N/A')}",
                'sector_analysis': ticker_data.get('sector', 'N/A')
            }
        )

        state["report"] = report
        return state

    def prepare_context(self, ticker, ticker_data, indicators):
        """Prepare context for LLM with uncertainty components"""
        current_price = indicators.get('current_price', 0)
        current_volume = indicators.get('volume', 0)
        volume_sma = indicators.get('volume_sma', 0)

        # Get uncertainty score and its components
        uncertainty_score = indicators.get('uncertainty_score', 0)
        atr = indicators.get('atr', 0)
        vwap = indicators.get('vwap', 0)

        # Calculate buy/sell pressure indicators
        if vwap and vwap > 0:
            price_vs_vwap_pct = ((current_price - vwap) / vwap) * 100
        else:
            price_vs_vwap_pct = 0

        if volume_sma and volume_sma > 0:
            volume_ratio = current_volume / volume_sma
        else:
            volume_ratio = 1.0

        # Interpret uncertainty level (don't show score, just interpretation)
        if uncertainty_score < 25:
            uncertainty_level = "‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏°‡∏≤‡∏Å - ‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏°‡∏î‡∏∏‡∏• ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß"
        elif uncertainty_score < 50:
            uncertainty_level = "‡∏ï‡∏•‡∏≤‡∏î‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ - ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"
        elif uncertainty_score < 75:
            uncertainty_level = "‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏™‡∏π‡∏á - ‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏°‡∏î‡∏∏‡∏• ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏∞‡∏ó‡∏±‡∏ô‡∏´‡∏±‡∏ô"
        else:
            uncertainty_level = "‡∏ï‡∏•‡∏≤‡∏î‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á - ‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ä‡∏ô‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏±‡∏Å ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"

        # Interpret volatility (ATR) as percentage
        if atr and current_price > 0:
            atr_percent = (atr / current_price) * 100
            if atr_percent < 1:
                volatility_desc = f"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å (ATR {atr_percent:.2f}%) - ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ä‡πâ‡∏≤ ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á"
            elif atr_percent < 2:
                volatility_desc = f"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (ATR {atr_percent:.2f}%) - ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥"
            elif atr_percent < 4:
                volatility_desc = f"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏™‡∏π‡∏á (ATR {atr_percent:.2f}%) - ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏Å‡∏ß‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡∏≠‡∏≤‡∏à‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á 3-5% ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢"
            else:
                volatility_desc = f"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (ATR {atr_percent:.2f}%) - ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏Å‡∏ß‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏°‡∏≤‡∏Å ‡∏≠‡∏≤‡∏à‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á 5-10% ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô"
        else:
            volatility_desc = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡πÑ‡∏î‡πâ"

        # Interpret buy/sell pressure from VWAP
        if price_vs_vwap_pct > 3:
            vwap_desc = f"‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏£‡∏á‡∏°‡∏≤‡∏Å - ‡∏£‡∏≤‡∏Ñ‡∏≤ {price_vs_vwap_pct:.1f}% ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ VWAP ({vwap:.2f}) ‡∏Ñ‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡∏≠‡∏°‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏û‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏á"
        elif price_vs_vwap_pct > 1:
            vwap_desc = f"‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏î‡∏µ - ‡∏£‡∏≤‡∏Ñ‡∏≤ {price_vs_vwap_pct:.1f}% ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ VWAP ({vwap:.2f}) ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤"
        elif price_vs_vwap_pct > -1:
            vwap_desc = f"‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏°‡∏î‡∏∏‡∏• - ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á VWAP ({vwap:.2f}) ‡∏ï‡∏•‡∏≤‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ä‡∏±‡∏î"
        elif price_vs_vwap_pct > -3:
            vwap_desc = f"‡πÅ‡∏£‡∏á‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ - ‡∏£‡∏≤‡∏Ñ‡∏≤ {abs(price_vs_vwap_pct):.1f}% ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ VWAP ({vwap:.2f}) ‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏î‡∏±‡∏ô‡∏Ç‡∏≤‡∏¢"
        else:
            vwap_desc = f"‡πÅ‡∏£‡∏á‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å - ‡∏£‡∏≤‡∏Ñ‡∏≤ {abs(price_vs_vwap_pct):.1f}% ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ VWAP ({vwap:.2f}) ‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏¢‡∏¢‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏∑‡πà‡∏ô‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏Å"

        # Interpret volume
        if volume_ratio > 2.0:
            volume_desc = f"‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î {volume_ratio:.1f}x ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ - ‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß"
        elif volume_ratio > 1.5:
            volume_desc = f"‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á {volume_ratio:.1f}x ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å"
        elif volume_ratio > 0.7:
            volume_desc = f"‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥ ({volume_ratio:.1f}x ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)"
        else:
            volume_desc = f"‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡πÄ‡∏á‡∏µ‡∏¢‡∏ö {volume_ratio:.1f}x ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ - ‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡∏ô‡πÉ‡∏à ‡∏≠‡∏≤‡∏à‡∏£‡∏≠‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà"

        context = f"""
‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå: {ticker}
‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: {ticker_data.get('company_name', ticker)}
‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: {current_price:.2f}
‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {ticker_data.get('date')}

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Fundamental Analysis):
- Market Cap: {self._format_number(ticker_data.get('market_cap'))}
- P/E Ratio: {ticker_data.get('pe_ratio', 'N/A')}
- Forward P/E: {ticker_data.get('forward_pe', 'N/A')}
- EPS: {ticker_data.get('eps', 'N/A')}
- Dividend Yield: {self._format_percent(ticker_data.get('dividend_yield'))}
- Sector: {ticker_data.get('sector', 'N/A')}
- Industry: {ticker_data.get('industry', 'N/A')}
- Revenue Growth: {self._format_percent(ticker_data.get('revenue_growth'))}
- Earnings Growth: {self._format_percent(ticker_data.get('earnings_growth'))}
- Profit Margin: {self._format_percent(ticker_data.get('profit_margin'))}

‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ (Technical Analysis):
- SMA 20: {indicators.get('sma_20', 'N/A'):.2f}
- SMA 50: {indicators.get('sma_50', 'N/A'):.2f}
- SMA 200: {indicators.get('sma_200', 'N/A'):.2f}
- RSI: {indicators.get('rsi', 'N/A'):.2f}
- MACD: {indicators.get('macd', 'N/A'):.2f}
- Signal: {indicators.get('macd_signal', 'N/A'):.2f}
- Bollinger Upper: {indicators.get('bb_upper', 'N/A'):.2f}
- Bollinger Middle: {indicators.get('bb_middle', 'N/A'):.2f}
- Bollinger Lower: {indicators.get('bb_lower', 'N/A'):.2f}

‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°: {self.technical_analyzer.analyze_trend(indicators, current_price)}
‡πÇ‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡∏±‡∏°: {self.technical_analyzer.analyze_momentum(indicators)}
MACD Signal: {self.technical_analyzer.analyze_macd(indicators)}
Bollinger: {self.technical_analyzer.analyze_bollinger(indicators)}

‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ï‡∏•‡∏≤‡∏î (Market Condition - USE THESE IN YOUR NARRATIVE):
‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {uncertainty_level}

1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô (Volatility): {volatility_desc}

2. ‡πÅ‡∏£‡∏á‡∏ã‡∏∑‡πâ‡∏≠-‡∏Ç‡∏≤‡∏¢ (Buy/Sell Pressure): {vwap_desc}

3. ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢ (Volume): {volume_desc}

‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (Relative Analysis):
- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: {ticker_data.get('recommendation', 'N/A').upper()}
- ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: {ticker_data.get('target_mean_price', 'N/A')}
- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: {ticker_data.get('analyst_count', 'N/A')}
- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 52 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå: {ticker_data.get('fifty_two_week_high', 'N/A')}
- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î 52 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå: {ticker_data.get('fifty_two_week_low', 'N/A')}
"""
        return context

    def _format_number(self, value):
        """Format large numbers"""
        if value is None:
            return "N/A"
        if value >= 1e12:
            return f"{value/1e12:.2f}T"
        elif value >= 1e9:
            return f"{value/1e9:.2f}B"
        elif value >= 1e6:
            return f"{value/1e6:.2f}M"
        else:
            return f"{value:,.0f}"

    def _format_percent(self, value):
        """Format percentage"""
        if value is None:
            return "N/A"
        return f"{value*100:.2f}%"

    def analyze_ticker(self, ticker: str) -> str:
        """Main entry point to analyze ticker"""
        initial_state = {
            "messages": [],
            "ticker": ticker,
            "ticker_data": {},
            "indicators": {},
            "report": "",
            "error": ""
        }

        # Run the graph
        final_state = self.graph.invoke(initial_state)

        # Return error or report
        if final_state.get("error"):
            return f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {final_state['error']}"

        return final_state.get("report", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ")

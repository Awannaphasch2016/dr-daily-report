# Dockerfile for Fund Data Sync Lambda
#
# Purpose: Container image for event-driven ETL pipeline
# Handler: src/lambda_handlers/fund_data_sync_handler.lambda_handler
#
# Build:
#   docker build -f Dockerfile.fund-data-sync -t fund-data-sync:latest .
#
# Deploy to ECR:
#   aws ecr get-login-password --region ap-southeast-1 | docker login --username AWS --password-stdin <account-id>.dkr.ecr.ap-southeast-1.amazonaws.com
#   docker tag fund-data-sync:latest <account-id>.dkr.ecr.ap-southeast-1.amazonaws.com/dr-daily-report-fund-data-sync:latest
#   docker push <account-id>.dkr.ecr.ap-southeast-1.amazonaws.com/dr-daily-report-fund-data-sync:latest

# Use AWS Lambda Python 3.11 base image
FROM public.ecr.aws/lambda/python:3.11

# Set working directory
WORKDIR ${LAMBDA_TASK_ROOT}

# Install system dependencies
RUN yum install -y gcc gcc-c++ make && \
    yum clean all && \
    rm -rf /var/cache/yum

# Copy minimal requirements for Fund Data Sync
COPY requirements-fund-data-sync.txt .

# Install Python dependencies (minimal set - no LangChain/tiktoken needed)
RUN pip install --no-cache-dir -r requirements-fund-data-sync.txt

# Copy application code
COPY src/ ${LAMBDA_TASK_ROOT}/src/
COPY db/ ${LAMBDA_TASK_ROOT}/db/

# Copy handler to root (Lambda runtime expects handlers at root level)
COPY src/lambda_handlers/fund_data_sync_handler.py ${LAMBDA_TASK_ROOT}/fund_data_sync_handler.py

# Fix file permissions for Lambda runtime (Lambda runs as sbx_user, needs read access)
RUN chmod -R 755 ${LAMBDA_TASK_ROOT}

# Set handler (handler is now at root level)
CMD ["fund_data_sync_handler.lambda_handler"]
